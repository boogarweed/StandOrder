@rendermode InteractiveServer
@page "/customer-order"
@using StandOrder.Data
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using System.Text
@inject IDbContextFactory<MyAppDbContext> DbFactory
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<h3>Walk Through Order</h3>

<div class="p-3">
    <EditForm Model="@order" OnValidSubmit="HandleSubmit">
        <!-- Customer selector -->
        <div class="form-group mb-2">
            <label>Customer:</label>
            <select class="form-control" @bind="selectedCustomerId" disabled="@(isBusy || draftOrderId != null)">
                <option value="">-- Select Customer --</option>
                @foreach (var c in customers)
                {
                    <option value="@c.ID">@c.Name</option>
                }
            </select>
        </div>

        <!-- Order Type selector -->
        <div class="form-group mb-2">
            <label>Order Type:</label>
            <InputRadioGroup @bind-Value="order.TypeOrder" disabled="@isBusy">
                <InputRadio Value=@("Case") /> Case
                <InputRadio Value=@("Broken") /> Broken
            </InputRadioGroup>
        </div>

        <!-- Quantity -->
        <div class="form-group mb-2">
            <label>Quantity:</label>
            <InputNumber class="form-control" @bind-Value="currentQuantity" disabled="@isBusy" />
        </div>

        <!-- Barcode scan -->
        <div class="form-group mb-3">
            <label>Scan Barcode:</label>
            <input class="form-control"
                   @ref="barcodeInput"
                   @onkeydown="HandleScannerKeyDown"
                   @onkeydown:preventDefault="true"
                   disabled="@isBusy" />
        </div>

        <!-- Order items list -->
        <h4>Order Items</h4>
        <ul class="list-group mb-3">
            @foreach (var item in orderDetails)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex flex-column">
                        <span class="fw-bold">@item.ProductName</span>
                        <small class="text-muted">ID: @item.ProductID</small>
                    </div>
                    <div>
                        <span class="badge bg-primary rounded-pill me-2">
                            @item.QuantityOrdered
                        </span>
                        <button type="button" class="btn btn-sm btn-danger"
                                @onclick="() => RemoveProduct(item)" disabled="@isBusy">
                            Remove
                        </button>
                    </div>
                </li>
            }
        </ul>

        <!-- Submit -->
        <button type="submit" class="btn btn-success" disabled="@isBusy">
            Submit Order
        </button>
    </EditForm>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-info mt-3">@statusMessage</div>
}

<!-- Product Selection Modal -->
@if (showProductSelectionModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Multiple Products Found</h5>
                    <button type="button" class="btn-close" @onclick="CancelProductSelection" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Please select the correct product for barcode '<strong>@scannedBarcode</strong>':</p>
                    <div class="list-group">
                        @foreach (var product in productsForSelection)
                        {
                            <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectProductFromModal(product)">
                                @product.ProductName
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}


<!-- JavaScript functions for local storage and input clearing -->
<script>
    window.standOrderStorage = {
      getCustomerOrderId: () => localStorage.getItem('customerOrderId'),
      setCustomerOrderId: (id) => localStorage.setItem('customerOrderId', id),
      clearCustomerOrderId: () => localStorage.removeItem('customerOrderId')
    };

    window.clearBarcodeInput = (el) => { if(el) { el.value = ''; } };
</script>

@code {
    // Local ViewModel for display purposes
    public class CustomerOrderDetailViewModel
    {
        public int ProductID { get; set; }
        public string ProductName { get; set; }
        public int QuantityOrdered { get; set; }
    }

    // DTO for dropdown binding
    private class CustomerDto
    {
        public int ID { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    List<CustomerDto> customers = new();
    int? selectedCustomerId;

    string scannedBarcode = string.Empty;
    int currentQuantity = 1;
    List<CustomerOrderDetailViewModel> orderDetails = new();
    ElementReference barcodeInput;
    string statusMessage = string.Empty;
    bool isBusy = false;

    // Draft-order tracking
    int? draftOrderId;

    // New state for handling multiple products
    bool showProductSelectionModal = false;
    List<Product> productsForSelection = new();

    StringBuilder _scanBuffer = new();

    public class OrderInput
    {
        public string TypeOrder { get; set; } = "Case";
        public string EmailAddress { get; set; } = "snodgrass.devin@yahoo.com";
        public string PhoneNumber { get; set; } = "405-795-2858";
        public DateTime? PickUpTime { get; set; } = DateTime.Now;
        public string LastName { get; set; } = "SHOWROOM";
    }
    OrderInput order = new();

    protected override async Task OnInitializedAsync()
    {
        await using var db = DbFactory.CreateDbContext();
        customers = await db.Customers
            .Where(c => c.FullName != null)
            .OrderBy(c => c.FullName)
            .Select(c => new CustomerDto
            {
                ID = c.CustomerID,
                Name = c.FullName!
            })
            .ToListAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await barcodeInput.FocusAsync();

            var stored = await JS.InvokeAsync<string>("standOrderStorage.getCustomerOrderId");
            if (int.TryParse(stored, out var oid))
            {
                isBusy = true;
                StateHasChanged();
                try
                {
                    await using var db = DbFactory.CreateDbContext();
                    draftOrderId = oid;

                    var draftOrder = await db.OrdersTaken
                        .AsNoTracking()
                        .FirstOrDefaultAsync(o => o.OrdersTakenID == oid);

                    if (draftOrder != null)
                    {
                        selectedCustomerId = draftOrder.CustomerID;
                        order.TypeOrder = draftOrder.TypeOrder;

                        var detailData = await db.OrdersTakenDetails
                            .AsNoTracking()
                            .Where(d => d.OrdersTakenID == oid)
                            .Select(d => new { d.ProductID, d.QuantityOrdered })
                            .ToListAsync();

                        var newOrderDetails = new List<CustomerOrderDetailViewModel>();
                        foreach (var detail in detailData)
                        {
                            var product = await db.Products
                                .AsNoTracking()
                                .FirstOrDefaultAsync(p => p.ProductID == detail.ProductID);

                            newOrderDetails.Add(new CustomerOrderDetailViewModel
                            {
                                ProductID = detail.ProductID,
                                ProductName = product?.ProductName ?? "[Product Not Found]",
                                QuantityOrdered = detail.QuantityOrdered
                            });
                        }
                        orderDetails = newOrderDetails;
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("standOrderStorage.clearCustomerOrderId");
                        draftOrderId = null;
                    }
                }
                finally
                {
                    isBusy = false;
                    StateHasChanged();
                }
            }
        }
    }

    async Task HandleScannerKeyDown(KeyboardEventArgs e)
    {
        if (isBusy) return;

        if (e.Key == "Enter")
        {
            isBusy = true;
            StateHasChanged();

            scannedBarcode = _scanBuffer.ToString();
            _scanBuffer.Clear();
            await JS.InvokeVoidAsync("clearBarcodeInput", barcodeInput);

            try
            {
                if (selectedCustomerId == null)
                {
                    statusMessage = "Please select a customer before scanning.";
                    ResetForNextScan();
                    return;
                }

                if (string.IsNullOrEmpty(scannedBarcode)) return;

                if (draftOrderId == null)
                {
                    await CreateDraftOrderAsync();
                }

                await using var db = DbFactory.CreateDbContext();
                var year = DateTime.Now.Year.ToString();
                var matchingProducts = await (
                    from b in db.Barcodes
                    join p in db.Products on b.UniversalItemNumber equals p.UniversalItemNumber
                    where b.BarCode == scannedBarcode && p.ProductYear == year
                    select p
                ).ToListAsync();

                if (matchingProducts.Count == 1)
                {
                    await AddProductToOrder(matchingProducts.First());
                    ResetForNextScan();
                }
                else if (matchingProducts.Count > 1)
                {
                    productsForSelection = matchingProducts;
                    showProductSelectionModal = true;
                }
                else
                {
                    statusMessage = $"Product not found for '{scannedBarcode}'.";
                    ResetForNextScan();
                }
            }
            finally
            {
                if (!showProductSelectionModal)
                {
                    isBusy = false;
                    StateHasChanged();
                    await barcodeInput.FocusAsync();
                }
            }
        }
        else if (e.Key.Length == 1)
        {
            _scanBuffer.Append(e.Key);
        }
    }

    async Task SelectProductFromModal(Product product)
    {
        showProductSelectionModal = false;
        productsForSelection.Clear();

        try
        {
            await AddProductToOrder(product);
        }
        finally
        {
            ResetForNextScan();
            isBusy = false;
            StateHasChanged();
            await barcodeInput.FocusAsync();
        }
    }

    async Task CancelProductSelection()
    {
        showProductSelectionModal = false;
        productsForSelection.Clear();
        ResetForNextScan();
        isBusy = false;
        StateHasChanged();
        await barcodeInput.FocusAsync();
    }

    async Task CreateDraftOrderAsync()
    {
        await using var db = DbFactory.CreateDbContext();
        var customer = await db.Customers.FindAsync(selectedCustomerId.Value);
        var entity = new OrdersTaken
        {
            CustomerID = selectedCustomerId.Value,
            Status = "Draft",
            OrderYear = DateTime.Now.Year.ToString(),
            TypeOrder = order.TypeOrder,
            EmailAddress = order.EmailAddress,
            PhoneNumber = order.PhoneNumber,
            PickUpTime = order.PickUpTime,
            LastName = customer?.FullName,
            TimeTaken = DateTime.Now
        };

        db.OrdersTaken.Add(entity);
        await db.SaveChangesAsync();

        draftOrderId = entity.OrdersTakenID;
        await JS.InvokeVoidAsync("standOrderStorage.setCustomerOrderId", draftOrderId.Value);
    }

    async Task AddProductToOrder(Product product)
    {
        await using var db = DbFactory.CreateDbContext();
        db.Products.Attach(product); // Attach the product to the current context

        decimal quantityToAdjust = 0;
        if (order.TypeOrder == "Broken")
        {
            if (product.PacksPerCase.HasValue && product.PacksPerCase > 0)
            {
                quantityToAdjust = (decimal)currentQuantity / product.PacksPerCase.Value;
            }
            else
            {
                statusMessage = $"Product '{product.ProductName}' does not have a valid 'PacksPerCase' value for a 'Broken' order.";
                return;
            }
        }
        else
        {
            quantityToAdjust = currentQuantity;
        }

        product.QtyInStock -= quantityToAdjust;

        var existing = orderDetails.FirstOrDefault(x => x.ProductID == product.ProductID);
        if (existing != null)
        {
            existing.QuantityOrdered += currentQuantity;
            orderDetails.Remove(existing);
            orderDetails.Insert(0, existing);
            await db.Database.ExecuteSqlRawAsync(
                "UPDATE OrdersTakenDetails SET QuantityOrdered = {0}, QuantityPulled = {0} WHERE OrdersTakenID = {1} AND ProductID = {2}",
                existing.QuantityOrdered,
                draftOrderId,
                product.ProductID
            );
            statusMessage = $"Updated {product.ProductName ?? "[No Name]"}: qty {existing.QuantityOrdered}";
        }
        else
        {
            orderDetails.Insert(0, new CustomerOrderDetailViewModel
            {
                ProductID = product.ProductID,
                ProductName = product.ProductName ?? "[No Name]",
                QuantityOrdered = currentQuantity
            });

            await db.Database.ExecuteSqlRawAsync(
                "INSERT INTO OrdersTakenDetails (OrdersTakenID, ProductID, QuantityOrdered, QuantityPulled) VALUES ({0}, {1}, {2}, {2})",
                draftOrderId.Value,
                product.ProductID,
                currentQuantity
            );
            statusMessage = $"Added {product.ProductName ?? "[No Name]"}";
        }

        await db.SaveChangesAsync(); // Save changes for stock adjustment
    }

    void ResetForNextScan()
    {
        scannedBarcode = "";
        currentQuantity = 1;
    }

    async Task RemoveProduct(CustomerOrderDetailViewModel item)
    {
        if (isBusy) return;
        isBusy = true;
        try
        {
            await using var db = DbFactory.CreateDbContext();

            var product = await db.Products.FindAsync(item.ProductID);
            if (product != null)
            {
                decimal quantityToReverse = 0;
                if (order.TypeOrder == "Broken")
                {
                    if (product.PacksPerCase.HasValue && product.PacksPerCase > 0)
                    {
                        quantityToReverse = (decimal)item.QuantityOrdered / product.PacksPerCase.Value;
                    }
                }
                else
                {
                    quantityToReverse = item.QuantityOrdered;
                }

                product.QtyInStock += quantityToReverse;
                await db.SaveChangesAsync();
            }

            orderDetails.Remove(item);
            if (draftOrderId != null)
            {
                await db.Database.ExecuteSqlRawAsync(
                    "DELETE FROM OrdersTakenDetails WHERE OrdersTakenID = {0} AND ProductID = {1}",
                    draftOrderId,
                    item.ProductID
                );
            }
        }
        finally
        {
            isBusy = false;
        }
    }

    async Task HandleSubmit()
    {
        if (draftOrderId == null)
        {
            statusMessage = "No order started. Please scan an item.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var entityToUpdate = new OrdersTaken { OrdersTakenID = draftOrderId.Value };
        db.OrdersTaken.Attach(entityToUpdate);

        entityToUpdate.Status = "Pulled";

        await db.SaveChangesAsync();

        statusMessage = $"Order saved (ID: {draftOrderId.Value})";

        await JS.InvokeVoidAsync("standOrderStorage.clearCustomerOrderId");
        draftOrderId = null;
        selectedCustomerId = null;
        order = new OrderInput();
        orderDetails.Clear();
        ResetForNextScan();
    }
}
