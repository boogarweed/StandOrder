@rendermode InteractiveServer
@page "/"
@page "/showroom-order"
@using StandOrder.Data
@using Microsoft.AspNetCore.Components.Web
@using System.Text
@using Microsoft.EntityFrameworkCore
@inject MyAppDbContext db
@inject IJSRuntime JS

<h3>Showroom Order</h3>

<EditForm Model="@order" OnValidSubmit="HandleSubmit">

    <!-- Quantity first -->
    <div class="form-group">
        <label>Quantity:</label>
        <InputNumber class="form-control" @bind-Value="currentQuantity" />
    </div>

    <!-- Then Barcode -->
    <div class="form-group">
        <label>Scan Barcode:</label>
        <input class="form-control"
               @ref="barcodeInput"
               @onkeydown="HandleScannerKeyDown"
               @onkeydown:preventDefault="true" />
    </div>

    <!-- Order items list -->
    <h4 class="mt-3">Order Items</h4>
    <ul class="list-group mb-3">
        @foreach (var item in orderDetails)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex flex-column">
                    <span class="fw-bold">@item.ProductName</span>
                    <small class="text-muted">ID: @item.ProductID</small>
                </div>
                <div>
                    <span class="badge bg-primary rounded-pill me-2">
                        @item.QuantityOrdered
                    </span>
                    <button type="button" class="btn btn-sm btn-danger"
                            @onclick="() => RemoveProduct(item)">
                        Remove
                    </button>
                </div>
            </li>
        }
    </ul>

    <button type="submit" class="btn btn-success">Submit Order</button>
</EditForm>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-info mt-3">@statusMessage</div>
}

<!-- Inline script to clear the input’s value -->
<script>
  window.clearBarcodeInput = (el) => { el.value = ''; }
</script>

@code {
    // Local ViewModel for display purposes
    public class OrderDetailViewModel
    {
        public int ProductID { get; set; }
        public string ProductName { get; set; }
        public int QuantityOrdered { get; set; }
    }
    
    // Form model with defaults
    public class OrderInput
    {
        public string TypeOrder { get; set; } = "Broken";
        public string EmailAddress { get; set; } = "snodgrass.devin@yahoo.com";
        public string PhoneNumber { get; set; } = "405-795-2858";
        public DateTime? PickUpTime { get; set; } = DateTime.Now;
        public string LastName { get; set; } = "SHOWROOM";
    }

    OrderInput order = new();
    List<OrderDetailViewModel> orderDetails = new(); // Use the ViewModel
    string scannedBarcode = "";
    int currentQuantity = 1;
    string statusMessage = "";

    ElementReference barcodeInput;
    StringBuilder _scanBuffer = new();

    // Auto-focus on load
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await barcodeInput.FocusAsync();
    }

    async Task HandleScannerKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Scanner finished sending the code
            scannedBarcode = _scanBuffer.ToString();
            _scanBuffer.Clear();

            await JS.InvokeVoidAsync("clearBarcodeInput", barcodeInput);

            await AddProduct();
        }
        else if (e.Key.Length == 1)
        {
            // Append any single-char keys (letters, digits, symbols)
            _scanBuffer.Append(e.Key);
        }
        // ignore other keys (Shift, Ctrl, etc.)

        await barcodeInput.FocusAsync();
    }

    async Task AddProduct()
    {
        var code = (scannedBarcode ?? "").Trim();
        var year = DateTime.Now.Year.ToString();

        var product = await (
            from b in db.Barcodes
            join p in db.Products on b.UniversalItemNumber equals p.UniversalItemNumber
            where b.BarCode == code
               && p.ProductYear == year
            select p
        ).FirstOrDefaultAsync();

        if (product != null)
        {
            var existing = orderDetails.FirstOrDefault(x => x.ProductID == product.ProductID);
            if (existing != null)
            {
                existing.QuantityOrdered += currentQuantity;
                statusMessage = $"Updated {product.ProductName} - {product.ProductID}: qty {existing.QuantityOrdered}";
            }
            else
            {
                orderDetails.Add(new OrderDetailViewModel
                {
                    ProductID = product.ProductID,
                    ProductName = product.ProductName, // Store the product name
                    QuantityOrdered = currentQuantity
                });
                statusMessage = $"Added {product.ProductName} - {product.ProductID}";
            }
        }
        else
        {
            statusMessage = $"Product not found for '{code}' / {year}.";
        }

        // clear & refocus
        currentQuantity = 1;
        await Task.Delay(50);
        await barcodeInput.FocusAsync();
    }

    void RemoveProduct(OrderDetailViewModel item) // Update parameter type
        => orderDetails.Remove(item);

    // Manual save logic
    async Task HandleSubmit()
    {
        // Map the ViewModel back to the EF Core entity before saving
        var detailsToSave = orderDetails.Select(vm => new OrdersTakenDetails
        {
            ProductID = vm.ProductID,
            QuantityOrdered = vm.QuantityOrdered
        }).ToList();
        
        var entity = new OrdersTaken
        {
            CustomerID = 845,
            Status = "Taken",
            OrderYear = DateTime.Now.Year.ToString(),
            TypeOrder = order.TypeOrder,
            EmailAddress = order.EmailAddress,
            PhoneNumber = order.PhoneNumber,
            PickUpTime = order.PickUpTime,
            LastName = order.LastName,
            TimeTaken = DateTime.Now,
            OrdersTakenDetails = detailsToSave
        };

        db.OrdersTaken.Add(entity);
        await db.SaveChangesAsync();

        statusMessage = $"Order saved (ID: {entity.OrdersTakenID})";
        order = new OrderInput();
        orderDetails.Clear();
    }
}
